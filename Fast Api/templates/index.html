<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modesta Store - Elegant Modest Fashion</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #e84393;
            --secondary: #5f27cd;
            --bg-gradient: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 50%, #fff5f8 100%);
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding-top: 85px;
            padding-bottom: 50px;
            color: #2d3436;
        }
        
        /* Header */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fad0c4 100%);
            padding: 15px 30px;
            box-shadow: 0 4px 30px rgba(255, 154, 158, 0.4);
            z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px;}
        
        .cart-btn {
            background: white; color: var(--primary); border: none;
            padding: 10px 20px; border-radius: 25px; font-weight: bold; font-family: 'Tajawal';
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .cart-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }

        /* Hero */
        .hero { text-align: center; padding: 40px 20px; animation: fadeInUp 0.6s ease-out; }
        .hero h1 {
            font-size: 52px; font-family: 'Playfair Display';
            background: linear-gradient(135deg, #e84393, #a55eea); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        /* Categories */
        .cats-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 40px; }
        .cat-card {
            background: white; padding: 20px 30px; border-radius: 20px; text-decoration: none; color: #333;
            box-shadow: 0 8px 20px rgba(232, 67, 147, 0.1); transition: 0.3s; text-align: center; min-width: 150px;
            border: 2px solid transparent;
        }
        .cat-card:hover, .cat-card.active { transform: translateY(-5px); border-color: var(--primary); }
        .cat-card i { font-size: 30px; color: var(--primary); margin-bottom: 10px; display: block; }

        /* Products Grid */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px; max-width: 1200px; margin: 0 auto; padding: 20px;
        }
        .card {
            background: white; border-radius: 25px; overflow: hidden; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s; animation: fadeInUp 0.5s ease-out;
        }
        .card:hover { transform: translateY(-10px); box-shadow: 0 20px 50px rgba(232, 67, 147, 0.2); }
        .card img { width: 100%; height: 280px; object-fit: cover; }
        .card-body { padding: 20px; text-align: center; }
        .card h3 { margin: 5px 0; font-size: 18px; }
        .price { color: var(--primary); font-size: 24px; font-weight: 800; }
        
        .add-btn {
            background: var(--primary); color: white; border: none; width: 100%;
            padding: 12px; border-radius: 15px; cursor: pointer; font-weight: bold; margin-top: 10px;
            background: linear-gradient(135deg, #ff9a9e 0%, #e84393 100%);
        }
        .add-btn:hover { opacity: 0.9; }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 25px;
            max-height: 85vh; overflow-y: auto; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .cart-item {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
            padding: 10px; background: #fff9fc; border-radius: 15px;
            border: 1px solid #ffe4ec;
        }
        .cart-controls button {
            width: 28px; height: 28px; border-radius: 50%; border: none;
            cursor: pointer; background: white; color: var(--secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold;
        }
        .cart-controls button:hover { background: var(--primary); color: white; }

        /* Qty Selector Modal Styles */
        .qty-selector {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            margin: 25px 0;
        }
        .qty-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #f0f0f0; font-size: 20px; cursor: pointer; transition: 0.2s;
            color: var(--secondary);
        }
        .qty-btn:hover { background: var(--primary); color: white; }
        .qty-display { font-size: 24px; font-weight: bold; width: 50px; text-align: center; }

        /* Checkout Styles */
        .checkout-field {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border-radius: 12px; border: 2px solid #eee;
            font-family: 'Tajawal'; font-size: 16px; transition: 0.3s;
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }
        .checkout-field:focus { border-color: var(--primary); outline: none; }
        
        .btn-confirm {
            width: 100%; background: linear-gradient(135deg, #00b894, #00cec9);
            color: white; border: none; padding: 15px; border-radius: 15px;
            font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        .btn-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4); }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-mosque"></i> Modesta</div>
        <button class="cart-btn" onclick="toggleCart()">
            <i class="fas fa-shopping-bag"></i> Cart (<span id="cart-count">0</span>)
        </button>
    </header>

    <div class="hero">
        <h1>MODESTA</h1>
        <p>Where Modesty Meets Elegance</p>
    </div>

    <!-- Jinja2 Loop for Categories -->
    <div class="cats-container">
        <a href="/?category=All" class="cat-card {% if current_category == 'All' %}active{% endif %}">
            <i class="fas fa-th-large"></i> All
        </a>
        {% for cat in categories %}
        <a href="/?category={{ cat }}" class="cat-card {% if current_category == cat %}active{% endif %}">
            {% if cat == 'Abayas' %}<i class="fas fa-person-dress"></i>
            {% elif cat == 'Khimars' %}<i class="fas fa-user-nurse"></i>
            {% elif cat == 'Niqabs' %}<i class="fas fa-mask"></i>
            {% else %}<i class="fas fa-gem"></i>{% endif %}
            {{ cat }}
        </a>
        {% endfor %}
    </div>

    <!-- Product Grid -->
    <div class="grid">
        {% for p in products %}
        <div class="card">
            {% if p.badge %}
            <div style="position: absolute; top: 15px; left: 15px; background: #e84393; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">{{ p.badge }}</div>
            {% endif %}
            <img src="{{ p.image_url }}" alt="{{ p.name }}">
            <div class="card-body">
                <h3>{{ p.name }}</h3>
                <p style="color: #888; font-size: 14px; margin-bottom: 5px;">{{ p.name_ar }}</p>
                <div class="price">{{ p.price | int }} <span style="font-size: 14px;">EGP</span></div>
                
                <button class="add-btn" 
                    data-id="{{ p.id }}" 
                    data-name="{{ p.name }}" 
                    data-price="{{ p.price }}" 
                    data-img="{{ p.image_url }}"
                    onclick="openQtyModal(this)">
                    Add to Cart <i class="fas fa-cart-plus"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Quantity Selection Modal -->
    <div id="qty-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: var(--secondary); margin-top: 0;">Add to Cart</h3>
            <img id="qty-img" src="" style="width: 120px; height: 120px; object-fit: cover; border-radius: 15px; margin: 10px 0;">
            <h4 id="qty-name" style="margin: 5px 0;">Product Name</h4>
            <p id="qty-price" style="color: var(--primary); font-weight: bold;">0 EGP</p>

            <div class="qty-selector">
                <button class="qty-btn" onclick="adjustModalQty(-1)">-</button>
                <span id="modal-qty-display" class="qty-display">1</span>
                <button class="qty-btn" onclick="adjustModalQty(1)">+</button>
            </div>

            <button onclick="confirmAddToCart()" class="btn-confirm" style="background: linear-gradient(135deg, #e84393, #fd79a8); box-shadow: 0 4px 15px rgba(232, 67, 147, 0.3);">
                Add to Cart
            </button>
            <button onclick="closeQtyModal()" style="background: none; border: none; color: #888; margin-top: 15px; cursor: pointer; text-decoration: underline;">Cancel</button>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--secondary); text-align: center; margin-bottom: 20px;"><i class="fas fa-shopping-bag"></i> Your Cart</h2>
            <div id="cart-items"></div>
            
            <div style="background: #d5f5e3; padding: 15px; border-radius: 15px; margin-top: 20px; display: flex; justify-content: space-between;">
                <strong>Total:</strong> <strong style="color: #27ae60;" id="cart-total">0 EGP</strong>
            </div>

            <div id="checkout-form" style="display: none; margin-top: 25px; padding-top: 20px; border-top: 2px dashed #eee;">
                <h3 style="color: var(--secondary); margin-bottom: 15px;"><i class="fas fa-shipping-fast"></i> Shipping Info</h3>
                <input type="text" id="c-name" class="checkout-field" placeholder="Full Name">
                <input type="text" id="c-phone" class="checkout-field" placeholder="Phone Number">
                <textarea id="c-addr" class="checkout-field" placeholder="Full Address" rows="3"></textarea>
                <button onclick="submitOrder()" class="btn-confirm">Confirm Order <i class="fas fa-check"></i></button>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="toggleCart()" style="flex: 1; padding: 12px; border: none; background: #f1f2f6; border-radius: 15px; color: #636e72; font-weight: bold; cursor: pointer;">Close</button>
                <button id="btn-checkout" onclick="showCheckout()" style="flex: 1; padding: 12px; border: none; background: var(--secondary); color: white; border-radius: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(95, 39, 205, 0.3);">Checkout</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        let cart = JSON.parse(localStorage.getItem('modesta_cart')) || [];
        
        // Variables for Quantity Modal
        let currentProduct = null;
        let currentQty = 1;

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
            localStorage.setItem('modesta_cart', JSON.stringify(cart));
        }

        // --- NEW: Quantity Modal Logic ---
        function openQtyModal(btn) {
            currentProduct = {
                id: parseInt(btn.dataset.id),
                name: btn.dataset.name,
                price: parseFloat(btn.dataset.price),
                img: btn.dataset.img
            };
            currentQty = 1;
            
            // Populate Modal
            document.getElementById('qty-img').src = currentProduct.img;
            document.getElementById('qty-name').innerText = currentProduct.name;
            document.getElementById('qty-price').innerText = currentProduct.price + " EGP";
            document.getElementById('modal-qty-display').innerText = currentQty;
            
            // Show Modal
            document.getElementById('qty-modal').style.display = 'flex';
        }

        function adjustModalQty(change) {
            currentQty += change;
            if (currentQty < 1) currentQty = 1;
            document.getElementById('modal-qty-display').innerText = currentQty;
        }

        function confirmAddToCart() {
            if (currentProduct) {
                addToCart(currentProduct.id, currentProduct.name, currentProduct.price, currentProduct.img, currentQty);
                closeQtyModal();
            }
        }

        function closeQtyModal() {
            document.getElementById('qty-modal').style.display = 'none';
            currentProduct = null;
        }

        function addToCart(id, name, price, img, qty) {
            let existing = cart.find(item => item.id === id);
            if (existing) {
                existing.qty += qty;
            } else {
                cart.push({ id, name, price, img, qty });
            }
            updateCartUI();
            
            // Show a small notification toast? For now native alert is okay or we can just proceed silently
            // alert(`Added ${qty} x ${name} to cart!`); 
        }

        // --- Cart & Checkout Logic ---

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if(modal.style.display === 'flex') {
                renderCartItems();
                // Reset checkout view
                document.getElementById('checkout-form').style.display = 'none';
                document.getElementById('btn-checkout').style.display = cart.length ? 'block' : 'none';
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;

            if(cart.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 20px;"><i class="fas fa-shopping-basket" style="font-size: 50px; color: #ddd; margin-bottom:10px;"></i><p style="color:#999;">Cart is empty</p></div>';
                document.getElementById('btn-checkout').style.display = 'none';
            } else {
                document.getElementById('btn-checkout').style.display = 'block';
            }

            cart.forEach((item, index) => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.img}" width="60" style="border-radius: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #2d3436;">${item.name}</div>
                            <div style="color: #e84393; font-size: 14px;">${item.price} EGP</div>
                        </div>
                        <div class="cart-controls" style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="updateQty(${index}, -1)">-</button>
                            <span style="font-weight: bold; width: 20px; text-align: center;">${item.qty}</span>
                            <button onclick="updateQty(${index}, 1)">+</button>
                        </div>
                        <button onclick="removeItem(${index})" style="background: none; border: none; color: #ff7675; cursor: pointer; padding: 5px;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
            document.getElementById('cart-total').innerText = total + ' EGP';
        }

        function updateQty(index, change) {
            cart[index].qty += change;
            if (cart[index].qty <= 0) cart.splice(index, 1);
            updateCartUI();
            renderCartItems();
        }

        function removeItem(index) {
            cart.splice(index, 1);
            updateCartUI();
            renderCartItems();
        }

        function showCheckout() {
            document.getElementById('checkout-form').style.display = 'block';
            document.getElementById('btn-checkout').style.display = 'none';
            // Smooth scroll to bottom of modal
            document.querySelector('.modal-content').scrollTop = document.querySelector('.modal-content').scrollHeight;
        }

        async function submitOrder() {
            const name = document.getElementById('c-name').value;
            const phone = document.getElementById('c-phone').value;
            const addr = document.getElementById('c-addr').value;

            if(!name || !phone || !addr) {
                alert("Please fill all fields");
                return;
            }

            const orderData = {
                name: name,
                phone: phone,
                address: addr,
                items: cart.map(item => ({ product_id: item.id, quantity: item.qty }))
            };

            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                
                if(result.status === 'success') {
                    // Success Modal or Alert? Let's use alert for now but reset nicely
                    alert(`âœ¨ Order Confirmed! \nOrder ID: ${result.order_id}`);
                    cart = [];
                    updateCartUI();
                    toggleCart();
                    location.reload();
                }
            } catch (error) {
                alert("Error sending order. Make sure server is running.");
                console.error(error);
            }
        }
        
        updateCartUI();
    </script>
</body>
</html>
